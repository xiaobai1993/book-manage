# æœ¬åœ°æµ‹è¯•æŒ‡å— - å›¾ç‰‡åŠŸèƒ½

## âœ… ç¼–è¯‘çŠ¶æ€

ä»£ç å·²æˆåŠŸç¼–è¯‘ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```bash
cd /Users/cat/Desktop/book-manage
go run main.go
```

**é¢„æœŸè¾“å‡º**ï¼š
```
Server is running on port 8080
APIæ–‡æ¡£è¯·å‚è€ƒ API.md
æ•°æ®åº“è¿æ¥: postgres@localhost:5432/library_management
Database connection established successfully (type: postgres)
Database tables auto-migrated successfully
```

**æ³¨æ„**ï¼š
- å¦‚æœçœ‹åˆ° `Warning: Failed to initialize R2 service`ï¼Œè¯´æ˜ R2 é…ç½®æœ‰é—®é¢˜ï¼Œä½†ä¸ä¼šé˜»æ­¢æœåŠ¡å¯åŠ¨
- å¦‚æœçœ‹åˆ° `Database tables auto-migrated successfully`ï¼Œè¯´æ˜æ•°æ®åº“å­—æ®µå·²è‡ªåŠ¨æ·»åŠ 

### 2. éªŒè¯æ•°æ®åº“è¿ç§»

å¯åŠ¨æœåŠ¡åï¼ŒGORM ä¼šè‡ªåŠ¨è¿ç§»æ•°æ®åº“ã€‚å¦‚æœ `cover_image_url` å­—æ®µå·²å­˜åœ¨ï¼Œä¸ä¼šæŠ¥é”™ã€‚

**æ‰‹åŠ¨éªŒè¯**ï¼ˆå¯é€‰ï¼‰ï¼š

```sql
-- PostgreSQL
SELECT column_name, data_type, character_maximum_length 
FROM information_schema.columns 
WHERE table_name = 'book' 
AND column_name = 'cover_image_url';

-- åº”è¯¥è¿”å›ï¼š
-- cover_image_url | character varying | 500
```

## ğŸ“ æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1ï¼šéªŒè¯ API æ¥å£å­˜åœ¨

ä½¿ç”¨ curl æˆ– Postman æµ‹è¯•æ¥å£æ˜¯å¦å¯è®¿é—®ï¼š

```bash
# æµ‹è¯•å›¾ä¹¦è¯¦æƒ…æ¥å£ï¼ˆåº”è¯¥åŒ…å« cover_image_url å­—æ®µï¼‰
curl -X POST http://localhost:8080/api/book/detail \
  -H "Content-Type: application/json" \
  -d '{"token":"your-token","id":1}'
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "book": {
      "id": 1,
      "title": "ä¸‰ä½“",
      ...
      "cover_image_url": null,
      ...
    }
  }
}
```

### æµ‹è¯• 2ï¼šä¸Šä¼ å›¾ç‰‡ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

#### 2.1 å…ˆç™»å½•è·å–ç®¡ç†å‘˜ Token

```bash
curl -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@lib.com",
    "password": "your-password"
  }'
```

**ä¿å­˜è¿”å›çš„ token**ã€‚

#### 2.2 ä¸Šä¼ å›¾ç‰‡

```bash
curl -X POST http://localhost:8080/api/book/uploadCover \
  -F "token=your-admin-token" \
  -F "book_id=1" \
  -F "image=@/path/to/your/image.jpg"
```

**å‚æ•°è¯´æ˜**ï¼š
- `token`: ç®¡ç†å‘˜ç™»å½•åè·å–çš„ token
- `book_id`: å›¾ä¹¦IDï¼ˆå¿…é¡»æ˜¯å­˜åœ¨çš„å›¾ä¹¦ï¼‰
- `image`: å›¾ç‰‡æ–‡ä»¶è·¯å¾„ï¼ˆä½¿ç”¨ `@` å‰ç¼€ï¼‰

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "image_url": "https://your-public-url.r2.dev/book-covers/1_xxx.jpg",
    "book_id": 1
  }
}
```

### æµ‹è¯• 3ï¼šéªŒè¯å›¾ç‰‡ URL å¯è®¿é—®

å¤åˆ¶è¿”å›çš„ `image_url`ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ä¸Šä¼ çš„å›¾ç‰‡ã€‚

### æµ‹è¯• 4ï¼šæŸ¥çœ‹å›¾ä¹¦è¯¦æƒ…ï¼ˆåŒ…å«å›¾ç‰‡ URLï¼‰

```bash
curl -X POST http://localhost:8080/api/book/detail \
  -H "Content-Type: application/json" \
  -d '{"token":"your-token","id":1}'
```

**é¢„æœŸå“åº”**ä¸­çš„ `cover_image_url` åº”è¯¥åŒ…å«åˆšæ‰ä¸Šä¼ çš„å›¾ç‰‡ URLã€‚

### æµ‹è¯• 5ï¼šåˆ é™¤å›¾ç‰‡

```bash
curl -X POST http://localhost:8080/api/book/deleteCover \
  -H "Content-Type: application/json" \
  -d '{
    "token": "your-admin-token",
    "book_id": 1
  }'
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {}
}
```

å†æ¬¡æŸ¥çœ‹å›¾ä¹¦è¯¦æƒ…ï¼Œ`cover_image_url` åº”è¯¥ä¸º `null`ã€‚

## ğŸ” æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šæ­£å¸¸ä¸Šä¼ 

1. âœ… ä¸Šä¼  JPG æ ¼å¼å›¾ç‰‡ï¼ˆ< 5MBï¼‰
2. âœ… éªŒè¯è¿”å›å›¾ç‰‡ URL
3. âœ… éªŒè¯å›¾ç‰‡å¯è®¿é—®
4. âœ… éªŒè¯æ•°æ®åº“å·²æ›´æ–°

### åœºæ™¯ 2ï¼šæ ¼å¼éªŒè¯

1. âœ… ä¸Šä¼  PNG æ ¼å¼ï¼ˆåº”è¯¥æˆåŠŸï¼‰
2. âœ… ä¸Šä¼  WebP æ ¼å¼ï¼ˆåº”è¯¥æˆåŠŸï¼‰
3. âŒ ä¸Šä¼  PDF æ ¼å¼ï¼ˆåº”è¯¥å¤±è´¥ï¼Œè¿”å›é”™è¯¯ç  10021ï¼‰
4. âŒ ä¸Šä¼  TXT æ ¼å¼ï¼ˆåº”è¯¥å¤±è´¥ï¼Œè¿”å›é”™è¯¯ç  10021ï¼‰

### åœºæ™¯ 3ï¼šå¤§å°éªŒè¯

1. âŒ ä¸Šä¼  6MB å›¾ç‰‡ï¼ˆåº”è¯¥å¤±è´¥ï¼Œè¿”å›é”™è¯¯ç  10022ï¼‰
2. âœ… ä¸Šä¼  4MB å›¾ç‰‡ï¼ˆåº”è¯¥æˆåŠŸï¼‰

### åœºæ™¯ 4ï¼šæƒé™éªŒè¯

1. âŒ ä½¿ç”¨æ™®é€šç”¨æˆ· token ä¸Šä¼ ï¼ˆåº”è¯¥å¤±è´¥ï¼Œè¿”å›é”™è¯¯ç  10009ï¼‰
2. âœ… ä½¿ç”¨ç®¡ç†å‘˜ token ä¸Šä¼ ï¼ˆåº”è¯¥æˆåŠŸï¼‰

### åœºæ™¯ 5ï¼šæ›´æ–°å›¾ç‰‡

1. âœ… ä¸ºå·²æœ‰å›¾ç‰‡çš„å›¾ä¹¦ä¸Šä¼ æ–°å›¾ç‰‡
2. âœ… éªŒè¯æ—§å›¾ç‰‡è¢«åˆ é™¤ï¼ˆä» R2 åˆ é™¤ï¼‰
3. âœ… éªŒè¯æ–°å›¾ç‰‡ URL å·²æ›´æ–°

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å¯åŠ¨æ—¶æç¤º R2 æœåŠ¡åˆå§‹åŒ–å¤±è´¥ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. R2 é…ç½®ä¿¡æ¯ä¸æ­£ç¡®
2. ç½‘ç»œè¿æ¥é—®é¢˜
3. Cloudflare R2 å‡­è¯æ— æ•ˆ

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ `config/env.yaml` ä¸­çš„ R2 é…ç½®
2. éªŒè¯ Access Key å’Œ Secret Key æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

**æ³¨æ„**ï¼šå³ä½¿ R2 åˆå§‹åŒ–å¤±è´¥ï¼ŒæœåŠ¡ä»ä¼šå¯åŠ¨ï¼Œåªæ˜¯å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ä¸å¯ç”¨ã€‚

### Q2: ä¸Šä¼ å›¾ç‰‡æ—¶æç¤º"å›¾ç‰‡å­˜å‚¨æœåŠ¡æœªé…ç½®"ï¼Ÿ

**åŸå› **ï¼šR2 æœåŠ¡æœªæ­£ç¡®åˆå§‹åŒ–

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥å¯åŠ¨æ—¥å¿—ï¼ŒæŸ¥çœ‹ R2 åˆå§‹åŒ–é”™è¯¯
2. éªŒè¯é…ç½®ä¿¡æ¯æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤ç½‘ç»œå¯ä»¥è®¿é—® Cloudflare R2

### Q3: ä¸Šä¼ æˆåŠŸä½†å›¾ç‰‡ URL æ— æ³•è®¿é—®ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. Public URL é…ç½®é”™è¯¯
2. R2.dev å­åŸŸåæœªå¯ç”¨
3. å›¾ç‰‡è·¯å¾„ä¸æ­£ç¡®

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ `public_url` é…ç½®æ˜¯å¦æ­£ç¡®
2. åœ¨ Cloudflare Dashboard ç¡®è®¤ R2.dev å­åŸŸåå·²å¯ç”¨
3. éªŒè¯å›¾ç‰‡æ–‡ä»¶æ˜¯å¦çœŸçš„ä¸Šä¼ åˆ°äº† R2

### Q4: æ•°æ®åº“å­—æ®µæœªè‡ªåŠ¨æ·»åŠ ï¼Ÿ

**è§£å†³æ–¹æ³•**ï¼š
1. æ‰‹åŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬ï¼š`add_book_cover_image_url.sql`
2. æˆ–ä½¿ç”¨ GORM çš„ AutoMigrateï¼ˆé‡å¯æœåŠ¡ï¼‰

### Q5: æƒé™é”™è¯¯ï¼ˆ10009ï¼‰ï¼Ÿ

**åŸå› **ï¼šä½¿ç”¨çš„ token ä¸æ˜¯ç®¡ç†å‘˜ token

**è§£å†³æ–¹æ³•**ï¼š
1. ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•
2. ç¡®è®¤ç®¡ç†å‘˜é‚®ç®±åœ¨ `config/env.yaml` çš„ `admin_emails` åˆ—è¡¨ä¸­

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŸºç¡€åŠŸèƒ½
- [ ] æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸï¼ˆcover_image_url å­—æ®µå­˜åœ¨ï¼‰
- [ ] R2 æœåŠ¡åˆå§‹åŒ–æˆåŠŸï¼ˆæˆ–æ˜¾ç¤ºè­¦å‘Šä½†ä¸é˜»æ­¢å¯åŠ¨ï¼‰

### API æµ‹è¯•
- [ ] è·å–å›¾ä¹¦è¯¦æƒ…åŒ…å« `cover_image_url` å­—æ®µ
- [ ] å›¾ä¹¦æœç´¢è¿”å›åŒ…å« `cover_image_url` å­—æ®µ
- [ ] å¯ä»¥ä¸Šä¼ å›¾ç‰‡ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] ä¸Šä¼ åè¿”å›æ­£ç¡®çš„å›¾ç‰‡ URL
- [ ] å›¾ç‰‡ URL å¯ä»¥è®¿é—®
- [ ] å¯ä»¥åˆ é™¤å›¾ç‰‡ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] åˆ é™¤å `cover_image_url` ä¸º null

### éªŒè¯æµ‹è¯•
- [ ] æ ¼å¼éªŒè¯ï¼ˆJPG/PNG/WebP/GIF æˆåŠŸï¼Œå…¶ä»–å¤±è´¥ï¼‰
- [ ] å¤§å°éªŒè¯ï¼ˆ< 5MB æˆåŠŸï¼Œ> 5MB å¤±è´¥ï¼‰
- [ ] æƒé™éªŒè¯ï¼ˆç®¡ç†å‘˜æˆåŠŸï¼Œæ™®é€šç”¨æˆ·å¤±è´¥ï¼‰
- [ ] æ›´æ–°å›¾ç‰‡ï¼ˆæ›¿æ¢æ—§å›¾ç‰‡ï¼‰

## ğŸ¯ æµ‹è¯•å·¥å…·æ¨è

### å‘½ä»¤è¡Œå·¥å…·
- **curl** - æµ‹è¯• API æ¥å£
- **httpie** - æ›´å‹å¥½çš„ HTTP å®¢æˆ·ç«¯

### GUI å·¥å…·
- **Postman** - åŠŸèƒ½å¼ºå¤§çš„ API æµ‹è¯•å·¥å…·
- **Insomnia** - è½»é‡çº§ API å®¢æˆ·ç«¯
- **Thunder Client** (VS Code æ’ä»¶)

### ç¤ºä¾‹ï¼šä½¿ç”¨ httpie

```bash
# å®‰è£…
brew install httpie

# ç™»å½•
http POST http://localhost:8080/api/user/login \
  email=admin@lib.com \
  password=your-password

# ä¸Šä¼ å›¾ç‰‡
http -f POST http://localhost:8080/api/book/uploadCover \
  token=your-token \
  book_id=1 \
  image@/path/to/image.jpg
```

## âœ… æµ‹è¯•é€šè¿‡æ ‡å‡†

æ‰€æœ‰æµ‹è¯•é€šè¿‡åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… å¯åŠ¨æœåŠ¡æ— é”™è¯¯
2. âœ… ä¸Šä¼ å›¾ç‰‡æˆåŠŸå¹¶è¿”å› URL
3. âœ… å›¾ç‰‡ URL å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®
4. âœ… å›¾ä¹¦è¯¦æƒ…å’Œæœç´¢åŒ…å«å›¾ç‰‡ URL
5. âœ… å¯ä»¥åˆ é™¤å›¾ç‰‡
6. âœ… æ ¼å¼å’Œå¤§å°éªŒè¯æ­£å¸¸å·¥ä½œ
7. âœ… æƒé™æ§åˆ¶æ­£å¸¸å·¥ä½œ

## ğŸ‰ å®Œæˆ

å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ï¼Œè¯´æ˜å›¾ç‰‡åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼

ä¸‹ä¸€æ­¥ï¼š
1. éƒ¨ç½²åˆ° Render ç”Ÿäº§ç¯å¢ƒ
2. é…ç½® Render ç¯å¢ƒå˜é‡
3. æµ‹è¯•ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½

---

**æç¤º**ï¼šå¦‚æœé‡åˆ°é—®é¢˜ï¼ŒæŸ¥çœ‹æœåŠ¡æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚

