# 图书图片功能 PRD（产品需求文档）

## 1. 文档信息
- **功能名称**：图书图片管理功能
- **文档版本**：v1.0
- **创建日期**：2025年1月
- **关联系统**：图书管理系统 v1.0

## 2. 功能概述

### 2.1 功能背景
为提升图书管理系统的用户体验，增加图书封面图片展示功能，使图书信息更加直观、美观。图片存储采用 Cloudflare R2 对象存储服务（免费版），确保图片访问速度快、存储成本低。

### 2.2 功能目标
- 支持为每本图书上传封面图片
- 图片存储在 Cloudflare R2 对象存储中
- 支持图片的查看、更新、删除操作
- 在图书列表、详情页面展示图书封面
- 图片上传支持常见图片格式（JPG、PNG、WebP等）

### 2.3 目标用户
- **图书管理员**：负责图书图片的上传、更新、删除
- **普通用户**：查看图书封面图片

## 3. 功能需求

### 3.1 图片上传功能
#### 3.1.1 上传图书封面
- **功能描述**：管理员为图书上传封面图片，支持单张图片上传
- **前置条件**：用户已登录且具有管理员权限
- **输入**：
  - 图书ID（必填）
  - 图片文件（必填，支持 JPG、PNG、WebP、GIF 格式）
  - 图片大小限制：最大 5MB
- **处理流程**：
  1. 管理员选择图书并上传图片文件
  2. 系统验证图片格式和大小
  3. 系统生成唯一文件名（UUID + 原文件扩展名）
  4. 上传图片到 Cloudflare R2 存储桶
  5. 获取图片的公开访问 URL
  6. 将图片 URL 保存到数据库图书记录中
  7. 如果该图书已有图片，删除旧图片（可选，或保留历史）
- **输出**：返回图片 URL 和上传成功提示
- **特殊要求**：
  - 图片格式：JPG、PNG、WebP、GIF
  - 图片大小：最大 5MB
  - 图片尺寸：建议 800x1200 像素（竖版封面），系统自动压缩（可选）
- **异常处理**：
  - 图片格式不支持：提示"仅支持 JPG、PNG、WebP、GIF 格式"
  - 图片大小超限：提示"图片大小不能超过 5MB"
  - 图书不存在：提示"图书不存在"
  - 上传失败：提示"图片上传失败，请重试"

#### 3.1.2 删除图书封面
- **功能描述**：管理员删除图书的封面图片
- **前置条件**：用户已登录且具有管理员权限，图书存在封面图片
- **输入**：图书ID
- **处理流程**：
  1. 管理员选择需要删除封面的图书
  2. 系统从数据库获取图片 URL
  3. 从 Cloudflare R2 删除图片文件
  4. 清空数据库中的图片 URL 字段
- **输出**：删除成功提示
- **异常处理**：
  - 图书不存在：提示"图书不存在"
  - 图片不存在：提示"该图书没有封面图片"

### 3.2 图片展示功能
#### 3.2.1 图书列表展示
- **功能描述**：在图书列表页面展示图书封面缩略图
- **显示内容**：
  - 图书封面图片（缩略图，建议 200x300 像素）
  - 如果图书没有封面，显示默认占位图
- **性能要求**：
  - 使用 Cloudflare R2 的 CDN 加速
  - 图片懒加载，提升页面加载速度

#### 3.2.2 图书详情展示
- **功能描述**：在图书详情页面展示完整封面图片
- **显示内容**：
  - 图书封面图片（完整尺寸，建议 400x600 像素）
  - 如果图书没有封面，显示默认占位图

### 3.3 图片管理功能
#### 3.3.1 更新图书封面
- **功能描述**：管理员更新已有图书的封面图片
- **处理流程**：
  1. 管理员选择需要更新封面的图书
  2. 上传新图片文件
  3. 系统验证新图片格式和大小
  4. 上传新图片到 Cloudflare R2
  5. 删除旧图片（从 R2 删除）
  6. 更新数据库中的图片 URL
- **输出**：返回新图片 URL 和更新成功提示

## 4. 业务规则与约束

### 4.1 图片存储规则
- 存储服务：Cloudflare R2 对象存储（免费版）
- 存储桶命名：`book-covers-{环境}`（如：`book-covers-prod`）
- 文件命名规则：`{book_id}_{uuid}.{ext}`（如：`1_a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg`）
- 图片访问：通过 Cloudflare R2 的公开 URL 访问

### 4.2 权限规则
| 功能模块 | 普通用户 | 管理员 |
|---------|---------|--------|
| 查看图书封面 | √ | √ |
| 上传图书封面 | × | √ |
| 更新图书封面 | × | √ |
| 删除图书封面 | × | √ |

### 4.3 数据约束
- 图片格式：JPG、PNG、WebP、GIF
- 图片大小：最大 5MB
- 图片尺寸：建议 800x1200 像素（竖版封面）
- 每本图书最多 1 张封面图片
- 图片 URL 存储在数据库 `book` 表的 `cover_image_url` 字段

### 4.4 性能要求
- 图片上传响应时间 ≤ 3 秒
- 图片访问加载时间 ≤ 1 秒（通过 CDN）
- 支持并发上传（最多 10 个并发）

## 5. 技术实现要求

### 5.1 后端实现
- 使用 Cloudflare R2 SDK（Go 语言）
- 实现图片上传接口
- 实现图片删除接口
- 数据库字段：在 `book` 表增加 `cover_image_url` 字段（VARCHAR(500)，可为空）

### 5.2 前端实现
- 图片上传组件（支持拖拽上传）
- 图片预览功能
- 图片懒加载
- 默认占位图显示

### 5.3 存储配置
- Cloudflare R2 存储桶配置
- 公开访问策略配置
- 环境变量配置（R2 访问密钥、存储桶名称等）

## 6. 用户体验需求

### 6.1 界面要求
- 图片上传界面简洁易用
- 支持拖拽上传
- 上传进度显示
- 图片预览功能
- 错误提示明确

### 6.2 交互要求
- 上传成功后自动刷新图书信息
- 删除图片前需要确认
- 图片加载失败时显示占位图

## 7. 异常处理

### 7.1 上传异常
- 网络异常：提示"网络连接失败，请检查网络后重试"
- 存储服务异常：提示"图片存储服务暂时不可用，请稍后重试"
- 文件损坏：提示"图片文件已损坏，请重新选择"

### 7.2 访问异常
- 图片不存在：显示默认占位图
- 图片加载失败：显示默认占位图，并记录错误日志

## 8. 后续优化（非本期需求）
- 图片自动压缩和格式转换
- 多尺寸图片生成（缩略图、中等尺寸、原图）
- 图片批量上传
- 图片裁剪功能
- 图片水印功能

## 9. 附录

### 9.1 术语表
- **Cloudflare R2**：Cloudflare 提供的对象存储服务，兼容 S3 API
- **CDN**：内容分发网络，用于加速图片访问
- **UUID**：通用唯一识别码，用于生成唯一文件名

### 9.2 参考文档
- Cloudflare R2 官方文档：https://developers.cloudflare.com/r2/
- Cloudflare R2 Go SDK：https://github.com/cloudflare/terraform-provider-cloudflare
- 相关文档：本目录下的其他文档（API_IMAGE.md、Cloudflare_R2_实施方案.md 等）

