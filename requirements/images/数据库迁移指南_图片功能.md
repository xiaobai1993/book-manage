# 数据库迁移指南 - 图片功能

## 📋 概述

为了支持图书封面图片功能，需要在 `book` 表中添加 `cover_image_url` 字段。

## 🔍 检查当前数据库状态

### 方法一：使用 GORM AutoMigrate（推荐）

如果你的项目使用 GORM 的 AutoMigrate 功能，**无需手动执行 SQL**：

1. 启动应用时，GORM 会自动检测模型变化
2. 如果 `book` 表缺少 `cover_image_url` 字段，会自动添加
3. 查看启动日志，应该能看到：
   ```
   Database tables auto-migrated successfully
   ```

**优点**：
- 自动执行，无需手动操作
- 安全，不会影响现有数据
- 适用于开发和生产环境

### 方法二：手动执行 SQL（如果 AutoMigrate 失败）

如果 AutoMigrate 没有自动执行，可以手动执行 SQL：

#### PostgreSQL（Supabase/本地 PostgreSQL）

1. **登录数据库**：
   - Supabase：进入 SQL Editor
   - 本地 PostgreSQL：使用 psql 或数据库客户端

2. **执行迁移脚本**：
   ```sql
   -- 检查字段是否已存在
   SELECT column_name 
   FROM information_schema.columns 
   WHERE table_name = 'book' 
   AND column_name = 'cover_image_url';
   
   -- 如果不存在，执行添加字段
   ALTER TABLE "book" 
   ADD COLUMN IF NOT EXISTS "cover_image_url" VARCHAR(500) DEFAULT NULL;
   
   -- 添加注释（可选）
   COMMENT ON COLUMN "book"."cover_image_url" 
   IS '图书封面图片URL（存储在Cloudflare R2）';
   ```

3. **验证**：
   ```sql
   -- 查看表结构
   \d book
   
   -- 或查询字段信息
   SELECT column_name, data_type, character_maximum_length 
   FROM information_schema.columns 
   WHERE table_name = 'book' 
   AND column_name = 'cover_image_url';
   ```


## 📝 使用项目提供的迁移脚本

项目根目录提供了迁移脚本：`add_book_cover_image_url.sql`

### PostgreSQL 使用方式

1. **Supabase**：
   - 进入 SQL Editor
   - 复制 `add_book_cover_image_url.sql` 的内容
   - 粘贴并执行

2. **本地 PostgreSQL**：
   ```bash
   psql -U postgres -d library_management -f add_book_cover_image_url.sql
   ```


## ✅ 验证迁移成功

### 方法一：查询数据库

```sql
-- PostgreSQL
SELECT column_name, data_type, character_maximum_length, is_nullable
FROM information_schema.columns 
WHERE table_name = 'book' 
AND column_name = 'cover_image_url';
```

**预期结果**：
- `column_name`: `cover_image_url`
- `data_type`: `character varying`
- `character_maximum_length`: `500`
- `is_nullable`: `YES`

### 方法二：测试 API

1. **启动应用**：
   ```bash
   go run main.go
   ```

2. **测试获取图书详情**：
   ```bash
   curl -X POST http://localhost:8080/api/book/detail \
     -H "Content-Type: application/json" \
     -d '{"token":"your-token","id":1}'
   ```

3. **检查响应**：
   应该包含 `cover_image_url` 字段（可能为 `null`）

### 方法三：查看应用日志

启动应用时，查看日志输出：

```
Database tables auto-migrated successfully
```

如果看到这个日志，说明迁移成功。

## ⚠️ 注意事项

### 1. 数据安全

- `cover_image_url` 字段允许为 `NULL`（现有图书没有封面图片是正常的）
- 添加字段不会影响现有数据
- 现有图书的 `cover_image_url` 字段值将为 `NULL`

### 2. 回滚（如果需要）

如果需要回滚（删除字段）：

```sql
-- PostgreSQL
ALTER TABLE "book" DROP COLUMN IF EXISTS "cover_image_url";
```

**⚠️ 警告**：删除字段会永久丢失所有图书的封面图片 URL 数据！

### 3. 生产环境

在生产环境（如 Supabase）执行迁移时：

1. **备份数据库**（如果可能）
2. **在非高峰时段执行**
3. **先测试**：在测试环境验证迁移脚本
4. **监控**：执行后检查应用是否正常运行

## 🔄 新数据库初始化

如果你要创建全新的数据库，可以使用：

- **PostgreSQL**: `data_postgresql.sql`（已更新，包含 `cover_image_url` 字段）

这些脚本会创建完整的表结构，包括 `cover_image_url` 字段。

## 📊 字段说明

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| `cover_image_url` | VARCHAR | 500 | YES | NULL | 图书封面图片URL，存储在Cloudflare R2 |

**示例值**：
```
https://your-public-url.r2.dev/book-covers/1_a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
```

## 🆘 常见问题

### Q1: AutoMigrate 没有自动添加字段？

**A**: 
- 检查 GORM 模型定义是否正确（`models/book.go`）
- 查看启动日志是否有错误
- 手动执行 SQL 迁移脚本

### Q2: 执行 SQL 时提示字段已存在？

**A**: 
- 这是正常的，说明字段已经添加
- 可以忽略错误，或使用 `IF NOT EXISTS` 语法

### Q3: 如何查看所有图书的封面图片？

**A**: 
```sql
-- 查看有封面的图书
SELECT id, title, cover_image_url 
FROM book 
WHERE cover_image_url IS NOT NULL;

-- 查看没有封面的图书
SELECT id, title 
FROM book 
WHERE cover_image_url IS NULL;
```

### Q4: 迁移后应用无法启动？

**A**: 
- 检查数据库连接是否正常
- 查看应用日志中的错误信息
- 确认字段类型和长度是否正确

---

## ✅ 完成检查清单

迁移完成后，确认：

- [ ] `cover_image_url` 字段已添加到 `book` 表
- [ ] 字段类型为 `VARCHAR(500)`
- [ ] 字段允许为 `NULL`
- [ ] 应用启动时没有迁移错误
- [ ] API 返回的图书信息包含 `cover_image_url` 字段
- [ ] 现有图书的 `cover_image_url` 值为 `NULL`（正常）

---

## 🎉 完成

迁移完成后，你的图书管理系统就可以使用图片上传功能了！

下一步：
1. 配置 Cloudflare R2（如果还没配置）
2. 测试图片上传功能
3. 为现有图书上传封面图片

